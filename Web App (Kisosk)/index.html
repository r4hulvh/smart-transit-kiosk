<!DOCTYPE html>
<html>

<head>
  <title>Smart Ticketing</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      text-align: center;
      overflow: hidden;
      /* Hide scrollbar in full-screen */
    }

    .container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      margin: 20px auto;
      max-width: 1100px;
    }

    .left-panel,
    .right-panel {
      padding: 10px;
    }

    .left-panel {
      position: relative;
    }

    .camera-container {
      position: relative;
      width: 640px;
      height: 480px;
      border: 2px solid #333;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      margin: auto;
    }

    video,
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #stateOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      z-index: 10;
    }

    .right-panel {
      width: 400px;
      margin-left: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      min-height: 480px;
      padding: 20px;
      box-sizing: border-box;
    }

    #dynamicContent {
      font-size: 1.2em;
      text-align: center;
    }

    .button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 1em;
      cursor: pointer;
    }

    #cardPinInput {
      font-size: 1.2em;
      padding: 5px;
      text-align: center;
      width: 150px;
      margin-top: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    .hidden-section {
      margin-top: 50px;
      padding: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .status-item {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-item label {
      font-size: 1em;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>
  <h1>Smart Ticketing with RFID and Facial Recognition</h1>
  <div class="container">
    <div class="left-panel">
      <div class="camera-container">
        <video id="video" autoplay muted></video>
        <canvas id="canvas" class="overlay"></canvas>
        <div id="stateOverlay"></div>
      </div>
    </div>
    <div class="right-panel">
      <div id="dynamicContent">
        <h2>System Idle</h2>
      </div>
    </div>
  </div>

  <!-- Hidden section: College Status toggles -->
  <div class="hidden-section">
    <h3>College Status.</h3>
    <div id="collegeStatusContainer"></div>
  </div>

  <script src="config.js"></script>
  <script>
    // Initialize Firebase using the config from config.js
    // If config.js is missing, check config.example.js
    if (typeof firebaseConfig === 'undefined') {
      console.error("firebaseConfig is not defined. Make sure config.js exists and is loaded.");
      alert("Error: Firebase configuration missing. Please check the console.");
    } else {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let systemState = "IDLE";
    let ws;
    let currentCardData = {};
    let labeledFaceDescriptors = [];
    const CENTRAL_REGION = { x: 0.4, y: 0.4, width: 0.2, height: 0.2 };
    let selectedDestination = "";
    let travelDirection = "";
    let faceTimeout;

    function testFirebaseConnectivity() {
      db.collection("test").doc("test-doc").get()
        .then(doc => {
          if (doc.exists) {
            console.log("Firebase connectivity test, hello:", doc.data().hello);
          } else {
            console.error("Firebase test doc not found!");
          }
        })
        .catch(error => {
          console.error("Error reading Firebase test doc:", error);
        });
    }

    async function loadFaceRecognitionData() {
      try {
        await faceapi.nets.ssdMobilenetv1.loadFromUri('models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('models');
        console.log("Face recognition models loaded.");
        labeledFaceDescriptors = await loadLabeledFaces();
        console.log("Labeled faces loaded:", labeledFaceDescriptors);
      } catch (error) {
        console.error("Error loading face recognition data:", error);
      }
    }

    async function loadLabeledFaces() {
      const labels = ['User1', 'User2']; // TODO: Add your user names here (must match folder names in 'images/')
      const maxImages = 10;
      return Promise.all(labels.map(async label => {
        const descriptions = [];
        for (let i = 1; i <= maxImages; i++) {
          const imgPath = `images/${label}/${i}.jpg`;
          try {
            const img = await faceapi.fetchImage(imgPath);
            const detection = await faceapi.detectSingleFace(img)
              .withFaceLandmarks()
              .withFaceDescriptor();
            if (detection) {
              descriptions.push(detection.descriptor);
            }
          } catch (error) {
            break;
          }
        }
        return new faceapi.LabeledFaceDescriptors(label, descriptions);
      }));
    }

    // Use mDNS hostname for WebSocket URL.
    function initializeWebSocket() {
      const wsUrl = "ws://esp32system.local:81";
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        console.log("WebSocket connection opened.");
        ws.send(JSON.stringify({ command: "getStatus" }));
      };
      ws.onmessage = (event) => {
        console.log("Message from ESP32:", event.data);
        try {
          const msg = JSON.parse(event.data);
          if (msg.systemState) {
            systemState = msg.systemState;
            if (systemState === "OPTIONS") {
              updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
            } else if (systemState === "CONCESSION" || systemState === "REGULAR") {
              updateDynamicContent(
                `<h2>${systemState}</h2>
                <p>Please, Tap your Smart ID Card or Enter the PIN.</p>
                <input id="cardPinInput" type="text" maxlength="4" placeholder="Card PIN" />`
              );
              attachPinListener();
            }
          }
          if (msg.component === "rfid" && msg.uid) {
            let uid = msg.uid.toLowerCase();
            console.log("Received RFID UID:", uid);
            currentCardData.uid = uid;
            processRFID(uid);
          }
        } catch (e) {
          console.error("Error parsing WebSocket message:", e);
        }
      };
      ws.onerror = (err) => { console.error("WebSocket error:", err); };
      ws.onclose = () => { console.log("WebSocket connection closed."); };
    }

    function attachPinListener() {
      const pinInput = document.getElementById("cardPinInput");
      if (pinInput) {
        pinInput.addEventListener("input", function () {
          if (this.value.length === 4) {
            processPin(this.value);
            this.value = "";
          }
        });
      }
    }

    function processPin(pinValue) {
      console.log("PIN entered:", pinValue);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ command: "buzzerClick" }));
      }
      db.collection("pins").doc(pinValue).get()
        .then(doc => {
          if (doc.exists) {
            const uidFromPin = doc.data().card;
            console.log("PIN lookup successful, UID:", uidFromPin);
            ws.send(JSON.stringify({ command: "simulateRFID" }));
            processRFID(uidFromPin, true);
          } else {
            console.error("No PIN document found for PIN:", pinValue);
            updateDynamicContent("<p>Error: Invalid PIN.</p>");
          }
        })
        .catch(error => {
          console.error("Error fetching PIN data:", error);
          updateDynamicContent("<p>Error processing PIN.</p>");
        });
    }

    function updateDynamicContent(htmlContent) {
      document.getElementById("dynamicContent").innerHTML = htmlContent;
    }

    // Optional parameter bypassBlacklist (default false)
    function processRFID(uid, bypassBlacklist = false) {
      db.collection("cards").doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            currentCardData = { ...doc.data(), uid: uid };
            console.log("Firebase card data:", currentCardData);
            if (!bypassBlacklist && currentCardData.blacklist === true) {
              updateDynamicContent("<h2>Tag Disabled</h2><p>Tag disabled by owner!</p>");
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command: "longBeep" }));
              }
              setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify({ command: "returnOptions" }));
                }
                updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
              }, 2000);
            } else {
              if (systemState === "CONCESSION") {
                // Check for the existence of the "institution" field.
                if (!currentCardData.institution) {
                  updateDynamicContent("<h2>User not registered as student, please choose Regular</h2>");
                  if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ command: "longBeep" }));
                  }
                  setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                      ws.send(JSON.stringify({ command: "returnOptions" }));
                    }
                    updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
                  }, 3000);
                } else {
                  updateDynamicContent(
                    `<h2>Confirm Identity</h2>
                   <p>Are you ${currentCardData.name}, student of ${currentCardData.institution}?</p>
                   <button class="button" onclick="handleConcessionConfirmation(true)">Yes</button>
                   <button class="button" onclick="handleConcessionConfirmation(false)">No</button>`
                  );
                }
              } else if (systemState === "REGULAR") {
                updateDynamicContent(
                  `<h2>Confirm Identity</h2>
                 <p>Are you ${currentCardData.name}?</p>
                 <button class="button" onclick="handleConfirmation(true)">Yes</button>
                 <button class="button" onclick="handleConfirmation(false)">No</button>`
                );
              }
            }
          } else {
            console.error("No such card in Firebase for UID:", uid);
            updateDynamicContent("<p>Error: Card not found in database.</p>");
          }
        })
        .catch(error => {
          console.error("Error fetching card data from Firebase:", error);
          updateDynamicContent("<p>Error fetching card data.</p>");
        });
    }

    // For CONCESSION: handle confirmation with YES/NO buttons.
    function handleConcessionConfirmation(confirmed) {
      if (confirmed) {
        // Check institution status first.
        db.collection("clg_status").doc(currentCardData.institution).get()
          .then(doc => {
            if (doc.exists) {
              const status = doc.data().status;
              if (status === false) {
                updateDynamicContent("<h2>Your Institution is not operational.</h2><p>Choose Regular.</p>");
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify({ command: "longBeep" }));
                }
                setTimeout(() => {
                  if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ command: "returnOptions" }));
                  }
                  updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
                }, 3000);
              } else {
                updateDynamicContent(
                  `<h2>Travelling TO or FROM college?</h2>
                 <button class="button" onclick="chooseTravelDirection('TO')">TO</button>
                 <button class="button" onclick="chooseTravelDirection('FROM')">FROM</button>`
                );
              }
            } else {
              console.error("Institution status not found in Firebase.");
              updateDynamicContent("<p>Error: Institution status not found.</p>");
            }
          })
          .catch(error => {
            console.error("Error checking institution status:", error);
            updateDynamicContent("<p>Error checking institution status.</p>");
          });
      } else {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ command: "buzzerClick" }));
          ws.send(JSON.stringify({ command: "returnOptions" }));
        }
        updateDynamicContent("<h2>Operation Cancelled</h2><p>Please start again.</p>");
        setTimeout(() => {
          updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
        }, 2000);
      }
    }

    function handleConfirmation(confirmed) {
      if (confirmed) {
        if (systemState === "REGULAR") {
          updateDynamicContent("<h2>Regular Mode</h2><p>Please, Select Destination:</p>" +
            "<select id='destinationSelect'><option value='East Fort'>East Fort</option><option value='Thampanoor'>Thampanoor</option></select>" +
            "<br><button class='button' onclick='submitDestination()'>Submit</button>");
        }
      } else {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ command: "buzzerClick" }));
          ws.send(JSON.stringify({ command: "returnOptions" }));
        }
        updateDynamicContent("<h2>Operation Cancelled</h2><p>Please start again.</p>");
        setTimeout(() => {
          updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
        }, 2000);
      }
    }

    function chooseTravelDirection(direction) {
      travelDirection = direction;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ command: "buzzerClick" }));
      }
      updateDynamicContent("<h2>Face Recognition</h2><p>Please, Show face to camera.</p>");
      document.getElementById("stateOverlay").style.display = "none";
      startFaceRecognition();
    }

    function submitDestination() {
      const dest = document.getElementById("destinationSelect").value;
      selectedDestination = dest;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ command: "buzzerClick" }));
      }
      updateDynamicContent("<h2>Face Recognition</h2><p>Please, Show face to camera.</p>");
      document.getElementById("stateOverlay").style.display = "none";
      startFaceRecognition();
    }

    async function startFaceRecognition() {
      const video = document.getElementById("video");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = resolve;
          video.onerror = reject;
        });
        video.width = 640;
        video.height = 480;
      } catch (error) {
        console.error("Camera access error:", error);
        return;
      }
      const container = document.querySelector('.camera-container');
      let oldCanvas = document.getElementById("canvas");
      if (oldCanvas) { oldCanvas.remove(); }
      const canvas = faceapi.createCanvasFromMedia(video);
      canvas.setAttribute("id", "canvas");
      container.appendChild(canvas);
      faceapi.matchDimensions(canvas, { width: 640, height: 480 });

      const drawCentralBox = () => {
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#0000FF';
        ctx.lineWidth = 2;
        ctx.strokeRect(CENTRAL_REGION.x * 640, CENTRAL_REGION.y * 480, CENTRAL_REGION.width * 640, CENTRAL_REGION.height * 480);
      };
      drawCentralBox();

      const recognitionInterval = setInterval(async () => {
        try {
          const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.7 }))
            .withFaceLandmarks()
            .withFaceDescriptors();
          const validDetections = detections.filter(d => {
            const box = d.detection.box;
            const centerX = box.x + box.width / 2;
            const centerY = box.y + box.height / 2;
            return (centerX >= CENTRAL_REGION.x * 640 && centerX <= (CENTRAL_REGION.x + CENTRAL_REGION.width) * 640 &&
              centerY >= CENTRAL_REGION.y * 480 && centerY <= (CENTRAL_REGION.y + CENTRAL_REGION.height) * 480);
          });
          if (validDetections.length > 0) {
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
            validDetections.forEach(d => {
              const bestMatch = faceMatcher.findBestMatch(d.descriptor);
              const ctx = canvas.getContext("2d");
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              drawCentralBox();
              new faceapi.draw.DrawBox(d.detection.box, { label: bestMatch.label, lineWidth: 2, boxColor: "#0000FF" }).draw(canvas);
              if (bestMatch.label === currentCardData.name) {
                clearInterval(recognitionInterval);
                clearTimeout(faceTimeout);
                onFaceMatched();
              }
            });
          }
        } catch (error) {
          console.error("Face recognition error:", error);
        }
      }, 100);

      faceTimeout = setTimeout(() => {
        clearInterval(recognitionInterval);
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ command: "buzzerClick" }));
        }
        updateDynamicContent("<h2>Session Timeout!</h2>");
        setTimeout(() => {
          document.getElementById("stateOverlay").style.display = "block";
          updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ command: "returnOptions" }));
          }
        }, 3000);
      }, 10000);
    }

    function onFaceMatched() {
      console.log("Face matched with", currentCardData.name);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ command: "buzzerClick" }));
      }
      const ticketNo = Math.floor(Math.random() * 90000) + 10000;
      const now = new Date().toLocaleString();
      const logsRef = db.collection("cards").doc(currentCardData.uid).collection("logs");
      logsRef.orderBy("logNumber", "asc").get()
        .then(querySnapshot => {
          let nextLogNumber = 1;
          querySnapshot.forEach(doc => {
            const num = parseInt(doc.id);
            if (num >= nextLogNumber) nextLogNumber = num + 1;
          });
          if (nextLogNumber > 100) nextLogNumber = 1;
          if (systemState === "CONCESSION") {
            // If travelDirection is "TO", use the institution field; if "FROM", use from_clg.
            let destinationValue = (travelDirection === "TO") ? currentCardData.institution : currentCardData.from_clg;
            logsRef.doc(String(nextLogNumber)).set({
              type: "Concession",
              date_time: now,
              ticket_no: ticketNo,
              destination: destinationValue,
              boarding: "Paravankunnu",
              logNumber: nextLogNumber
            })
              .then(() => {
                console.log("Concession log created successfully with log number:", nextLogNumber);
                updateDynamicContent("<h2>Travel logged, please check app for details</h2>" +
                  "<p>Ticket No: " + ticketNo + "<br>Date: " + now + "<br>Destination: " + destinationValue + "<br>Boarding: Paravankunnu</p>");
                setTimeout(() => {
                  document.getElementById("stateOverlay").style.display = "block";
                  updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
                  if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ command: "returnOptions" }));
                  }
                }, 3000);
              })
              .catch(error => {
                console.error("Error creating concession log:", error);
                updateDynamicContent("<p>Error creating log. Please try again.</p>");
              });
          } else if (systemState === "REGULAR") {
            let amount = (selectedDestination === "East Fort") ? 12 : 15;
            if (Number(currentCardData.wallet) < amount) {
              updateDynamicContent("<h2>Insufficient wallet balance, please top-up.</h2>");
              setTimeout(() => {
                document.getElementById("stateOverlay").style.display = "block";
                updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify({ command: "returnOptions" }));
                }
              }, 3000);
            } else {
              logsRef.doc(String(nextLogNumber)).set({
                type: "Regular",
                date_time: now,
                ticket_no: ticketNo,
                destination: selectedDestination,
                amount: amount,
                boarding: "Paravankunnu",
                logNumber: nextLogNumber
              })
                .then(() => {
                  console.log("Regular log created successfully with log number:", nextLogNumber);
                  let newWallet = Number(currentCardData.wallet) - amount;
                  db.collection("cards").doc(currentCardData.uid).update({
                    wallet: newWallet
                  })
                    .then(() => {
                      console.log("Wallet updated. New wallet:", newWallet);
                      updateDynamicContent("<h2>Travel logged, please check app for details</h2>" +
                        "<p>Ticket No: " + ticketNo + "<br>Date: " + now + "<br>Destination: " + selectedDestination + "<br>Amount: " + amount + "<br>Boarding: Paravankunnu</p>");
                      setTimeout(() => {
                        document.getElementById("stateOverlay").style.display = "block";
                        updateDynamicContent("<h2>OPTIONS</h2><p style='text-align:center;'> <- 1) Concession<br><br>   2) Regular -></p>");
                        if (ws && ws.readyState === WebSocket.OPEN) {
                          ws.send(JSON.stringify({ command: "returnOptions" }));
                        }
                      }, 3000);
                    })
                    .catch(error => {
                      console.error("Error updating wallet:", error);
                      updateDynamicContent("<p>Error updating wallet. Please try again.</p>");
                    });
                })
                .catch(error => {
                  console.error("Error creating regular log:", error);
                  updateDynamicContent("<p>Error creating log. Please try again.</p>");
                });
            }
          }
        })
        .catch(error => {
          console.error("Error querying logs:", error);
          updateDynamicContent("<p>Error accessing logs.</p>");
        });
    }

    function loadCollegeStatusToggles() {
      const container = document.getElementById("collegeStatusContainer");
      container.innerHTML = "";
      db.collection("clg_status").get()
        .then(querySnapshot => {
          querySnapshot.forEach(doc => {
            const status = doc.data().status;
            const docId = doc.id;
            const div = document.createElement("div");
            div.className = "status-item";
            div.innerHTML = `<label>${docId}</label>
                           <label class="switch">
                             <input type="checkbox" id="toggle_${docId}" ${status ? "checked" : ""}>
                             <span class="slider"></span>
                           </label>`;
            container.appendChild(div);
            document.getElementById(`toggle_${docId}`).addEventListener("change", function () {
              const newStatus = this.checked;
              db.collection("clg_status").doc(docId).set({ status: newStatus }, { merge: true })
                .then(() => { console.log(`Status for ${docId} updated to ${newStatus}`); })
                .catch(error => { console.error(`Error updating status for ${docId}:`, error); });
            });
          });
        })
        .catch(error => {
          console.error("Error loading college statuses:", error);
        });
    }

    window.addEventListener("load", loadCollegeStatusToggles);

    window.addEventListener('load', () => {
      testFirebaseConnectivity();
      loadFaceRecognitionData();
      try {
        initializeWebSocket();
      } catch (e) {
        console.error("Error initializing WebSocket:", e);
      }
    });
  </script>
</body>

</html>