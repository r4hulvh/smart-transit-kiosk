#include <WiFi.h>
#include <ESPmDNS.h>          // Include mDNS support
#include <WebSocketsServer.h>
#include <SPI.h>
#include <MFRC522.h>
#include <Wire.h>
#include <Adafruit_SSD1306.h>

// ----- WiFi Credentials -----
const char* ssid     = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// ----- WebSocket Server -----
WebSocketsServer webSocket = WebSocketsServer(81);

// ----- Pin Definitions (based on your diagram) -----
// Touch Sensors
const int touchSensor1 = 4;
const int touchSensor2 = 15;
const int touchSensor3 = 13; // Used for RETURN function in CONCESSION/REGULAR

// OLED Display (assuming SSD1306)
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// RC522 RFID Module
#define RST_PIN 16
#define SS_PIN  17
MFRC522 mfrc522(SS_PIN, RST_PIN);

// IR Sensor (Active Low)
const int irSensorPin = 33;

// LED
const int ledPin = 25;

// Push Button (Emergency Stop)
const int buttonPin = 26;

// Buzzer
const int buzzerPin = 32;

// ----- System State Variables -----
String systemState = "IDLE";
unsigned long irTriggeredStartTime = 0;
bool waitingForRFID = false;
bool emergencyActive = false; // Emergency mode flag
String prevSystemState = "IDLE"; // To store state before emergency

void setup() {
  Serial.begin(115200);
  delay(100);
  
  // Initialize pins
  pinMode(touchSensor1, INPUT);
  pinMode(touchSensor2, INPUT);
  pinMode(touchSensor3, INPUT);
  pinMode(irSensorPin, INPUT);
  pinMode(ledPin, OUTPUT);
  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(buzzerPin, OUTPUT);

  // Initialize OLED: show "Waiting..." centered.
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED init failed");
  } else {
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(20, 28);
    display.println("Waiting...");
    display.display();
  }

  // Initialize RFID Reader
  SPI.begin();
  mfrc522.PCD_Init();
  Serial.println("RFID reader initialized.");

  // Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while(WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected. IP address: " + WiFi.localIP().toString());
  
  // Start mDNS responder
  if (!MDNS.begin("esp32system")) {
    Serial.println("Error setting up MDNS responder!");
  } else {
    Serial.println("mDNS responder started: esp32system.local");
  }
  MDNS.addService("ws", "tcp", 81);

  // Start WebSocket Server
  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  webSocket.loop();
  
  // Check for Emergency Stop button (active LOW)
  if(digitalRead(buttonPin) == LOW && !emergencyActive) {
    emergencyActive = true;
    prevSystemState = systemState;
    triggerEmergencyStop();
  }
  
  if(!emergencyActive) {
    checkIRSensor();    // Check IR sensor for IDLE -> OPTIONS transition.
    
    // In OPTIONS state, check touch sensor inputs.
    if(systemState == "OPTIONS") {
      if (digitalRead(touchSensor1) == HIGH) {  // Option 1: Concession.
        Serial.println("Touch Sensor 1 pressed in OPTIONS state.");
        transitionToConcession();
        delay(500);  // Reduced delay
      }
      else if (digitalRead(touchSensor2) == HIGH) {  // Option 2: Regular.
        Serial.println("Touch Sensor 2 pressed in OPTIONS state.");
        transitionToRegular();
        delay(500);  // Reduced delay
      }
    }
    
    // In CONCESSION or REGULAR state, check for RFID tap.
    if((systemState == "CONCESSION" || systemState == "REGULAR") && waitingForRFID) {
      if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
        Serial.println("RFID card detected in state: " + systemState);
        buzzerClick();
        displayProceedMessage();
        String uid = "";
        for (byte i = 0; i < mfrc522.uid.size; i++) {
          uid += String(mfrc522.uid.uidByte[i], HEX);
        }
        uid.toLowerCase();
        String jsonMsg = "{\"component\":\"rfid\",\"uid\":\"" + uid + "\"}";
        webSocket.broadcastTXT(jsonMsg);
        Serial.println("Sent RFID UID: " + uid);
        waitingForRFID = false;
      }
    }
    
    // In CONCESSION or REGULAR state, check for the Return function (Touch Sensor 3).
    if((systemState == "CONCESSION" || systemState == "REGULAR") && digitalRead(touchSensor3) == HIGH) {
      Serial.println("Return selected via Touch Sensor 3.");
      buzzerClick();
      returnToOptions();
      delay(500);  // Reduced debounce delay
    }
    
    sendSensorStatus();
  }
  
  delay(200);
}

void triggerEmergencyStop() {
  Serial.println("Emergency Stop Triggered!");
  systemState = "EMERGENCY";
  
  // Update OLED: font size 2, centered Emergency Stop message.
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(10, 20);
  display.println("Emergency");
  display.setCursor(30, 40);
  display.println("Stop");
  display.display();
  
  unsigned long startTime = millis();
  // Run emergency beep pattern for 3 seconds.
  while(millis() - startTime < 3000) {
    digitalWrite(buzzerPin, HIGH);
    digitalWrite(ledPin, HIGH);
    delay(700);
    digitalWrite(buzzerPin, LOW);
    digitalWrite(ledPin, LOW);
    delay(300);
    
    digitalWrite(buzzerPin, HIGH);
    digitalWrite(ledPin, HIGH);
    delay(400);
    digitalWrite(buzzerPin, LOW);
    digitalWrite(ledPin, LOW);
    delay(300);
    
    digitalWrite(buzzerPin, HIGH);
    digitalWrite(ledPin, HIGH);
    delay(400);
    digitalWrite(buzzerPin, LOW);
    digitalWrite(ledPin, LOW);
    delay(300);
  }
  
  // Restore previous state.
  systemState = prevSystemState;
  emergencyActive = false;
  Serial.println("Emergency cleared. Returning to state: " + systemState);
  
  if(systemState == "OPTIONS") {
    displayOptions();
  } else if(systemState == "CONCESSION" || systemState == "REGULAR") {
    displayConcessionPrompt();
  }
  webSocket.broadcastTXT("{\"systemState\":\"" + systemState + "\"}");
}

void checkIRSensor() {
  bool irTriggered = (digitalRead(irSensorPin) == LOW);
  
  if(systemState == "IDLE") {
    if(irTriggered) {
      if(irTriggeredStartTime == 0) {
        irTriggeredStartTime = millis();
      } else if(millis() - irTriggeredStartTime > 1000) {
        systemState = "OPTIONS";
        Serial.println("Transition to OPTIONS state due to IR trigger.");
        buzzerDoubleClick();
        displayOptions();
        webSocket.broadcastTXT("{\"systemState\":\"OPTIONS\"}");
      }
    } else {
      irTriggeredStartTime = 0;
    }
  }
}

void transitionToConcession() {
  if(systemState == "OPTIONS") {
    systemState = "CONCESSION";
    Serial.println("Transitioning to CONCESSION state.");
    buzzerClick();
    displayConcessionPrompt();
    webSocket.broadcastTXT("{\"systemState\":\"CONCESSION\"}");
    waitingForRFID = true;
  }
}

void transitionToRegular() {
  if(systemState == "OPTIONS") {
    systemState = "REGULAR";
    Serial.println("Transitioning to REGULAR state.");
    buzzerClick();
    displayConcessionPrompt();
    webSocket.broadcastTXT("{\"systemState\":\"REGULAR\"}");
    waitingForRFID = true;
  }
}

void returnToOptions() {
  systemState = "OPTIONS";
  waitingForRFID = false;
  displayOptions();
  webSocket.broadcastTXT("{\"systemState\":\"OPTIONS\"}");
  Serial.println("Returning to OPTIONS state via Return function.");
}

void buzzerClick() {
  digitalWrite(buzzerPin, HIGH);
  delay(100);
  digitalWrite(buzzerPin, LOW);
  delay(100);
}

void buzzerDoubleClick() {
  for (int i = 0; i < 2; i++) {
    digitalWrite(buzzerPin, HIGH);
    delay(100);
    digitalWrite(buzzerPin, LOW);
    delay(100);
  }
}

void displayOptions() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(10, 20);
  display.println(" <- 1) Concession");
  display.println("");
  display.println("");
  display.println("    2) Regular ->");
  display.display();
  Serial.println("OLED: Displaying OPTIONS state.");
}

void displayConcessionPrompt() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  // Updated prompt text includes PIN option.
  display.setCursor(5, 28);
  display.println("Please, Tap your");
  display.println("Smart ID Card or");
  display.println("Enter the PIN");
  // Display Return option at bottom center.
  display.setCursor(46, 56);
  display.println("Return");
  display.display();
  Serial.println("OLED: Prompting for smart card/PIN with Return option.");
}

void displayProceedMessage() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(5, 28);
  display.println("Please, Proceed");
  display.println("on Screen.");
  // Also display Return option.
  display.setCursor(46, 56);
  display.println("Return");
  display.display();
  Serial.println("OLED: Asking user to proceed on screen with Return option.");
}

void sendSensorStatus() {
  bool touch1 = digitalRead(touchSensor1);
  bool touch2 = digitalRead(touchSensor2);
  bool touch3 = digitalRead(touchSensor3);
  bool irState = (digitalRead(irSensorPin) == LOW);
  bool btnState = (digitalRead(buttonPin) == LOW);
  
  String jsonMsg;
  jsonMsg = "{\"component\":\"touch\",\"sensorId\":1,\"state\":" + String(touch1 ? "true" : "false") + "}";
  webSocket.broadcastTXT(jsonMsg);
  jsonMsg = "{\"component\":\"touch\",\"sensorId\":2,\"state\":" + String(touch2 ? "true" : "false") + "}";
  webSocket.broadcastTXT(jsonMsg);
  jsonMsg = "{\"component\":\"touch\",\"sensorId\":3,\"state\":" + String(touch3 ? "true" : "false") + "}";
  webSocket.broadcastTXT(jsonMsg);
  jsonMsg = "{\"component\":\"ir\",\"state\":" + String(irState ? "true" : "false") + "}";
  webSocket.broadcastTXT(jsonMsg);
  jsonMsg = "{\"component\":\"button\",\"state\":" + String(btnState ? "true" : "false") + "}";
  webSocket.broadcastTXT(jsonMsg);
}

void webSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
  String msg = "";
  switch(type) {
    case WStype_DISCONNECTED:
      Serial.printf("Client [%u] disconnected!\n", num);
      break;
    case WStype_CONNECTED: {
        IPAddress ip = webSocket.remoteIP(num);
        Serial.printf("Client [%u] connected from %d.%d.%d.%d\n", num, ip[0], ip[1], ip[2], ip[3]);
      }
      break;
    case WStype_TEXT: {
        msg = String((char *)payload);
        Serial.printf("Received message from client [%u]: %s\n", num, msg.c_str());
        if (msg.indexOf("ledOn") != -1) {
          digitalWrite(ledPin, HIGH);
          webSocket.sendTXT(num, "{\"component\":\"led\",\"state\":\"ON\"}");
        } else if (msg.indexOf("ledOff") != -1) {
          digitalWrite(ledPin, LOW);
          webSocket.sendTXT(num, "{\"component\":\"led\",\"state\":\"OFF\"}");
        } else if (msg.indexOf("buzzerTest") != -1) {
          digitalWrite(buzzerPin, HIGH);
          delay(500);
          digitalWrite(buzzerPin, LOW);
          webSocket.sendTXT(num, "{\"component\":\"buzzer\",\"state\":\"Tested\"}");
        } else if (msg.indexOf("buzzerClick") != -1) {
          buzzerClick();
          webSocket.sendTXT(num, "{\"component\":\"buzzer\",\"state\":\"Clicked\"}");
        } else if (msg.indexOf("longBeep") != -1) {
          digitalWrite(buzzerPin, HIGH);
          delay(1000);
          digitalWrite(buzzerPin, LOW);
          webSocket.sendTXT(num, "{\"component\":\"buzzer\",\"state\":\"LongBeeped\"}");
        } else if (msg.indexOf("simulateRFID") != -1) {
          displayProceedMessage();
          webSocket.sendTXT(num, "{\"component\":\"oled\",\"state\":\"ProceedDisplayed\"}");
        } else if (msg.indexOf("getStatus") != -1) {
          sendSensorStatus();
        } else if (msg.indexOf("returnOptions") != -1) {
          systemState = "OPTIONS";
          waitingForRFID = false;
          displayOptions();
          webSocket.broadcastTXT("{\"systemState\":\"OPTIONS\"}");
          Serial.println("Returning to OPTIONS state.");
        }
      }
      break;
    default:
      break;
  }
}
